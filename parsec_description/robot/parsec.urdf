<?xml version="1.0"?>
<robot xmlns:sensor="http://playerstage.sourceforge.net/gazebo/xmlschema/#sensor"
       xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
       xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface"
       name="parsec">

  <!-- Robot definition -->

  <link name="base_footprint">
    <inertial>
      <mass value="0.0001" />
      <origin xyz="0 0 0" />
      <inertia ixx="0.0001" ixy="0.0" ixz="0.0"
               iyy="0.0001" iyz="0.0"
               izz="0.001" />
    </inertial>
  </link>
  
  <link name="base_link">
    <inertial>
      <!-- We are just approximating the inertia matrix here by using
           the formula for a solid cylinder. The weight is just
           guessed. -->
      <mass value="15.0"/>
      <inertia ixx="0.0033" ixy="0" ixz="0" iyy="0.0033" iyz="0" izz="0.0315315"/>
    </inertial>
    <visual>
      <material name="Black"/>
      <geometry>
        <cylinder radius="0.21" length="0.01"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.21" length="0.01"/>
      </geometry>
    </collision>
  </link>

  <link name="left_wheel_link" >
    <inertial>
      <!-- Guessing the inertia matrix by approximating a wheel's
           weight with 0.5kg and using the formula for a solid
           cylinder -->
      <mass value="1.45"/>
      <inertia ixx="0.00013716" ixy="0" ixz="0" iyy="0.00013716" iyz="0" izz="0.002032" />
    </inertial>
    <visual>
      <material name="Black"/>      
      <geometry>
        <cylinder radius="0.0762" length="0.032"/>
        <color rgba="0 0 0 1"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.0762" length="0.032"/>
      </geometry>
    </collision>
  </link>

  <link name="right_wheel_link" >
    <inertial>
      <!-- Guessing the inertia matrix by approximating a wheel's
           weight with 0.5kg and using the formula for a solid
           cylinder -->
      <mass value="1.45"/>
      <inertia ixx="0.00013716" ixy="0" ixz="0" iyy="0.00013716" iyz="0" izz="0.002032" />      
    </inertial>
    <visual>
      <material name="Black"/>      
      <geometry>
        <cylinder radius="0.0762" length="0.032"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.0762" length="0.032"/>
      </geometry>
    </collision>
  </link>
  
  <link name="front_stabilizer_link">
    <inertial>
      <!-- Sort of ignoring inertia here -->
      <mass value="0.001"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.0001" />      
    </inertial>
    <visual>
      <origin xyz="0 0 -0.0381"/>
      <material name="Black"/>      
      <geometry>
        <box size="0.03 0.03 0.0762"/>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 -0.0381"/>      
      <geometry>
        <box size="0.03 0.03 0.0762"/>
      </geometry>
    </collision>    
  </link>
  
  <link name="rear_stabilizer_link">
    <inertial>
      <!-- Sort of ignoring inertia here -->      
      <mass value="0.001"/>
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.0001" />
    </inertial>
    <visual>
      <origin xyz="0 0 -0.0381"/>
      <material name="Black"/>      
      <geometry>
        <box size="0.03 0.03 0.0762"/>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 -0.0381"/>
      <geometry>
        <box size="0.03 0.03 0.0762"/>
      </geometry>
    </collision>
  </link>
  
  <link name="mast_link">
    <inertial>
      <!-- A heavy mast makes the model very unstable in gazebo. -->
      <!-- <mass value="1.5"/> -->
      <!-- <inertia ixx="0.3403626" ixy="0" ixz="0" iyy="0.3405125" iyz="0" izz="0.00025" /> -->
      <mass value="0.01"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001" />
    </inertial>
    <visual>
      <material name="Grey"/>      
      <geometry>
        <box size="0.04 0.02 1.65"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <box size="0.04 0.02 1.65"/>
      </geometry>
    </collision>
  </link>
  
  <link name="base_laser">
    <inertial>
      <mass value="0.001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.0001" />
    </inertial>
    <visual>
      <material name="Black"/>
      <geometry>
        <cylinder radius="0.0265" length="0.08"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.0265" length="0.08"/>
      </geometry>
    </collision>
  </link>

  <link name="tilt_laser_mount">
    <inertial>
      <mass value="0.001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.0001" />
    </inertial>
  </link>

  <link name="tilt_laser">
    <inertial>
      <mass value="0.001" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertia ixx="0.0001" ixy="0" ixz="0" iyy="0.000001" iyz="0" izz="0.0001" />
    </inertial>
    <visual>
      <material name="Black"/>
      <geometry>
        <cylinder radius="0.0265" length="0.08"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <cylinder radius="0.0265" length="0.08"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_footprint_joint" type="fixed">
    <parent link="base_footprint" />
    <child link="base_link" />
    <origin xyz="0 0 0.0762" rpy="0 0 0"/>
  </joint>
            
  <!-- <joint name="left_wheel_joint" type="continuous"> -->
  <joint name="left_wheel_joint" type="fixed">
    <parent link="base_link"/>
    <child link="left_wheel_link"/>
    <origin xyz="0 0.195 0" rpy="1.5707963268 0 0"/>
    <axis xyz="0 0 1"/>
  </joint>

  <!-- <joint name="right_wheel_joint" type="continuous"> -->
  <joint name="right_wheel_joint" type="fixed">
    <parent link="base_link"/>
    <child link="right_wheel_link"/>
    <origin xyz="0 -0.195 0" rpy="1.5707963268 0 0"/>
    <axis xyz="0 0 1"/>
  </joint>

  <joint name="front_stabilizer_joint" type="fixed">
    <parent link="base_link"/>
    <child link="front_stabilizer_link"/>
    <origin xyz="0.15 0 0"/>
  </joint>

  <joint name="rear_stabilizer_joint" type="fixed">
    <parent link="base_link"/>
    <child link="rear_stabilizer_link"/>
    <origin xyz="-0.15 0 0"/>
  </joint>

  <joint name="mast_joint" type="fixed">
    <parent link="base_link"/>
    <child link="mast_link"/>
    <origin xyz="0 0 0.83"/>
  </joint>

  <joint name="base_laser_joint" type="fixed">
    <parent link="mast_link"/>
    <child link="base_laser"/>
    <origin xyz="0.045 -0.015 -0.68"/>
  </joint>

  <joint name="tilt_laser_mount_joint" type="fixed">
    <parent link="mast_link"/>
    <child link="tilt_laser_mount"/>
    <!-- laser is 0.775m above the base, i.e. 0.05m below the center
    of the mast.-->
    <origin xyz="0.065 0 -0.05"/>
  </joint>

  <joint name="tilt_laser_joint" type="revolute">
    <parent link="tilt_laser_mount"/>
    <child link="tilt_laser"/>
    <origin xyz="0.0 -0.045 0.035" rpy="0 0.25 0"/>
    <axis xyz="0 1 0"/>
    <!-- Using dummy effort and velocity values here. They are not
    used on the parsec -->
    <limit lower="-1.5707963268"
           upper="1.5707963268" effort="1.0" velocity="10.0"/>
  </joint>

  <!-- Color definitions -->

  <material name="Black">
    <color rgba="0 0 0 1"/>
  </material>

  <material name="Grey">
    <color rgba="0.5 0.5 0.5 1"/>
  </material>

  <!-- Additional information for Gazebo -->
  
  <gazebo reference="left_wheel_link">
    <selfCollide>false</selfCollide>
  </gazebo>
  
  <gazebo reference="right_wheel_link">
    <selfCollide>false</selfCollide>
  </gazebo>

  <gazebo reference="front_stabilizer_link">
    <mu1>0.001</mu1>
    <mu2>0.001</mu2>
  </gazebo>

  <gazebo reference="rear_stabilizer_link">
    <mu1>0.001</mu1>
    <mu2>0.001</mu2>
  </gazebo>

  <gazebo reference="base_laser_link">
    <sensor:ray name="base_laser">
      <rayCount>682</rayCount>
      <rangeCount>682</rangeCount>
      <laserCount>1</laserCount>

      <origin>0.0 0.0 0.0</origin>
      <displayRays>false</displayRays>

      <minAngle>-120</minAngle>
      <maxAngle>120</maxAngle>

      <minRange>0.06</minRange>
      <maxRange>4.095</maxRange>
      <resRange>0.01</resRange>
      <updateRate>20.0</updateRate>
      <controller:gazebo_ros_laser name="gazebo_ros_base_laser_controller" plugin="libgazebo_ros_laser.so">
        <gaussianNoise>0.005</gaussianNoise>
        <alwaysOn>true</alwaysOn>
        <updateRate>20.0</updateRate>
        <topicName>base_laser</topicName>
        <frameName>base_laser_link</frameName>
        <interface:laser name="gazebo_ros_base_laser_iface" />
      </controller:gazebo_ros_laser>
    </sensor:ray>
  </gazebo>

  <!-- Add a dummy pose controller to get pose ground truth in simulation -->
  <gazebo>
    <controller:gazebo_ros_p3d name="p3d_base_controller" plugin="libgazebo_ros_p3d.so">
      <alwaysOn>true</alwaysOn>
      <updateRate>100.0</updateRate>
      <bodyName>base_link</bodyName>
      <topicName>base_pose_ground_truth</topicName>
      <gaussianNoise>0.01</gaussianNoise>
      <frameName>map</frameName>
      <xyzOffsets>0 0 0</xyzOffsets> <!-- initialize odometry for fake localization-->
      <rpyOffsets>0 0 0</rpyOffsets>
      <interface:position name="p3d_base_position"/>
    </controller:gazebo_ros_p3d>
  </gazebo>
</robot>
