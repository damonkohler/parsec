<launch>
  <include file="$(find parsec_description)/launch/upload_parsec.launch" />

  <rosparam>
    anonymous_1:
      laser_frame: base_laser
      laser_topic: parsec/base_scan
    anonymous_2:
      laser_frame: fixed_angle_laser
      laser_topic: parsec/fixed_angle_scan
    anonymous_3:
      laser_frame: tilt_laser
      laser_topic: parsec/tilt_scan
  </rosparam>

  <node name="parsec_odometry" type="parsec_odometry" pkg="parsec_odometry" output="screen">
    <remap from="~odom_simple" to="/odom_simple" />
    <remap from="~odom" to="/odom" />
    <remap from="~scan" to="/base_scan" />
    <rosparam>
      base_frame: base_footprint
    </rosparam>
  </node>
  <node name="parsec_state_publisher" type="state_publisher" pkg="robot_state_publisher" />
  <node name="servo_joint_state_publisher" type="publish_servo_joint_state.py"
        pkg="publish_servo_joint_state">
    <remap from="~signal" to="laser_tilt_controller/signal" />
    <remap from="~profile" to="rosserial/profile" />
  </node>
  <node name="joystick_safety_filter" type="cmd_vel_safety_filter" pkg="cmd_vel_safety_filter"
        output="screen">
    <remap from="~cmd_vel" to="virtual_joystick/cmd_vel" />
    <remap from="~scan" to="/base_scan" />
    <rosparam>
      radius: 0.25
      stop_distance: 0.45
      max_acceleration: 0.5
    </rosparam>
  </node>
  <node name="cmd_vel_mux" type="priority_mux" pkg="priority_mux">
    <remap from="~output" to="/cmd_vel" />
    <rosparam>
      incoming_topics: ["estop/cmd_vel", "joystick_safety_filter/cmd_vel_filtered", "move_base/cmd_vel"]
    </rosparam>
  </node>
  <node name="cmd_vel_mux_log" type="rosbag" pkg="rosbag"
        args="record cmd_vel_mux/log -o $(env HOME)/.ros/log/cmd_vel_mux_log" />
  <node name="robust_parsec_relay" type="robust_topic_relay" pkg="robust_topic_relay"
        output="screen">
    <rosparam>
      relayed_topics:
        - input_topic: /parsec/base_scan
          output_topic: /base_scan
          expected_frequency: 1.0
        - input_topic: /parsec/fixed_angle_scan
          output_topic: /fixed_angle_scan
          expected_frequency: 1.0
        - input_topic: /parsec/tilt_scan
          output_topic: /tilt_scan
          expected_frequency: 1.0
        - input_topic: /rosserial/odom_simple
          output_topic: /odom_simple
          expected_frequency: 1.0
        - input_topic: /rosserial/signal
          output_topic: /laser_tilt_controller/signal
          expected_frequency: 0.1
    </rosparam>
  </node>
</launch>
